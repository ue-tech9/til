AWSTemplateFormatVersion: '2010-09-09'
Description: Full Stack EC2 PoC (Public/Private/NFW Subnets + R53 Private DNS + VPC Endpoints + S3/Logs Reserves) - Extended with ASG counts (Linux/Windows Public/Private)

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "① Linux Configuration"
        Parameters:
          - CreateLinuxInstance
          - OsVersion
          - InstanceType
          - LinuxVolumeSize
          - LinuxPublicCount
          - LinuxPrivateCount
      - Label:
          default: "② Windows Configuration"
        Parameters:
          - CreateWindowsInstance
          - WindowsServerVersion
          - WindowsInstanceType
          - WindowsVolumeSize
          - WindowsPublicCount
          - WindowsPrivateCount
      - Label:
          default: "③ Network & Access"
        Parameters:
          - TargetAZ
          - EnableInternetAccess
          - EnableVPCEndpoints
          - AllowedCidr
      - Label:
          default: "④ Private DNS (Route53)"
        Parameters:
          - PrivateDomainName
      - Label:
          default: "⑤ Legacy (Single EC2 Instance) - Keep but Disabled by default"
        Parameters:
          - EnableLegacySingleInstances

    ParameterLabels:
      CreateLinuxInstance:
        default: "Enable Linux resources?"
      CreateWindowsInstance:
        default: "Enable Windows resources?"
      EnableInternetAccess:
        default: "Create IGW & NAT Gateway?"
      EnableVPCEndpoints:
        default: "Create VPC Endpoints?"
      PrivateDomainName:
        default: "Private Hosted Zone Name"
      LinuxPublicCount:
        default: "Linux (Public) instance count"
      LinuxPrivateCount:
        default: "Linux (Private) instance count"
      WindowsPublicCount:
        default: "Windows (Public) instance count"
      WindowsPrivateCount:
        default: "Windows (Private) instance count"
      EnableLegacySingleInstances:
        default: "Enable Legacy single EC2 resources? (NOT recommended)"

Parameters:
  TargetAZ:
    Description: Select the Availability Zone.
    Type: AWS::EC2::AvailabilityZone::Name

  CreateLinuxInstance:
    Type: String
    Default: "true"
    AllowedValues: ["true", "false"]
    Description: Master switch for Linux resources (ASG). If false, Linux ASGs won't be created.

  OsVersion:
    Type: String
    Default: AmazonLinux2
    AllowedValues:
      - AmazonLinux2023
      - AmazonLinux2
    Description: Select the OS version for Linux Server.

  InstanceType:
    Type: String
    Default: t3.medium
    AllowedValues:
      - t3.micro
      - t3.small
      - t3.medium
    Description: Select Linux instance type.

  LinuxVolumeSize:
    Type: Number
    Default: 50
    MinValue: 8
    MaxValue: 16000
    Description: Size of the root volume for Linux (GB).

  # --- NEW: Linux counts (Public / Private) ---
  LinuxPublicCount:
    Type: Number
    Default: 0
    MinValue: 0
    MaxValue: 50
    Description: Number of Linux instances to deploy in Public subnet (ASG DesiredCapacity).

  LinuxPrivateCount:
    Type: Number
    Default: 0
    MinValue: 0
    MaxValue: 50
    Description: Number of Linux instances to deploy in Private subnet (ASG DesiredCapacity).

  CreateWindowsInstance:
    Type: String
    Default: "true"
    AllowedValues: ["true", "false"]
    Description: Master switch for Windows resources (ASG). If false, Windows ASGs won't be created.

  WindowsServerVersion:
    Type: String
    Default: "2022"
    AllowedValues:
      - "2022"
      - "2019"
      - "2016"
    Description: Select Windows Server OS version.

  WindowsInstanceType:
    Type: String
    Default: t3.large
    AllowedValues:
      - t3.medium
      - t3.large
      - m5.large
    Description: Select Windows instance type.

  WindowsVolumeSize:
    Type: Number
    Default: 50
    MinValue: 30
    MaxValue: 16000
    Description: Size of the root volume for Windows (GB).

  # --- NEW: Windows counts (Public / Private) ---
  WindowsPublicCount:
    Type: Number
    Default: 0
    MinValue: 0
    MaxValue: 50
    Description: Number of Windows instances to deploy in Public subnet (ASG DesiredCapacity).

  WindowsPrivateCount:
    Type: Number
    Default: 0
    MinValue: 0
    MaxValue: 50
    Description: Number of Windows instances to deploy in Private subnet (ASG DesiredCapacity).

  EnableInternetAccess:
    Type: String
    Default: "true"
    AllowedValues: ["true", "false"]
    Description: If true, IGW and NAT Gateway are created. If false, Closed Network.

  EnableVPCEndpoints:
    Type: String
    Default: "true"
    AllowedValues: ["true", "false"]
    Description: Required for SSM/Yum/Logs if Internet Access is false.

  AllowedCidr:
    Type: String
    Default: 10.0.0.0/16
    Description: IP range allowed for SSH (22) and App Ports within SG.

  PrivateDomainName:
    Type: String
    Default: "corp.internal"
    Description: The domain name for the Private Hosted Zone (e.g. corp.internal).

  # --- NEW: Keep old single-instance resources but disable by default ---
  EnableLegacySingleInstances:
    Type: String
    Default: "false"
    AllowedValues: ["true", "false"]
    Description: If true, legacy AWS::EC2::Instance resources (PoCInstance/PoCWindowsInstance) are created. Not recommended.

Conditions:
  # Legacy flag
  UseLegacy: !Equals [ !Ref EnableLegacySingleInstances, "true" ]

  IsAmazonLinux2: !Equals [ !Ref OsVersion, "AmazonLinux2" ]
  IsInternetEnabled: !Equals [ !Ref EnableInternetAccess, "true" ]
  IsEndpointsEnabled: !Equals [ !Ref EnableVPCEndpoints, "true" ]

  # Legacy single EC2 create conditions (kept)
  BuildLinuxLegacy: !And [ !Condition UseLegacy, !Equals [ !Ref CreateLinuxInstance, "true" ] ]
  BuildWindowsLegacy: !And [ !Condition UseLegacy, !Equals [ !Ref CreateWindowsInstance, "true" ] ]

  # ASG create conditions (new)
  CreateLinuxPublicASG: !And
    - !Not [ !Condition UseLegacy ]
    - !Equals [ !Ref CreateLinuxInstance, "true" ]
    - !Not [ !Equals [ !Ref LinuxPublicCount, 0 ] ]

  CreateLinuxPrivateASG: !And
    - !Not [ !Condition UseLegacy ]
    - !Equals [ !Ref CreateLinuxInstance, "true" ]
    - !Not [ !Equals [ !Ref LinuxPrivateCount, 0 ] ]

  CreateWindowsPublicASG: !And
    - !Not [ !Condition UseLegacy ]
    - !Equals [ !Ref CreateWindowsInstance, "true" ]
    - !Not [ !Equals [ !Ref WindowsPublicCount, 0 ] ]

  CreateWindowsPrivateASG: !And
    - !Not [ !Condition UseLegacy ]
    - !Equals [ !Ref CreateWindowsInstance, "true" ]
    - !Not [ !Equals [ !Ref WindowsPrivateCount, 0 ] ]

Resources:
  # ============================================================
  # Key Pair (Common)
  # ============================================================
  PoCKeyPair:
    Type: AWS::EC2::KeyPair
    Properties:
      KeyName: !Sub "${AWS::StackName}-key"
      KeyType: rsa
      KeyFormat: pem

  # ============================================================
  # Base Network (VPC & Subnets)
  # ============================================================
  PoCVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-vpc"

  # Public Subnet (For NAT GW / IGW)
  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref PoCVPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Ref TargetAZ
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-public-subnet"

  # Private Subnet (For Instances & Endpoints)
  PrivateSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref PoCVPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Ref TargetAZ
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-private-subnet"

  # Network Firewall Subnet (Reserved for future NFW)
  FirewallSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref PoCVPC
      CidrBlock: 10.0.3.0/24
      AvailabilityZone: !Ref TargetAZ
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-nfw-subnet"

  # ============================================================
  # Route 53 Resolver DNS Firewall (Keeping as independent security layer)
  # ============================================================
  DnsFwDomainListAllow:
    Type: AWS::Route53Resolver::FirewallDomainList
    Properties:
      Name: !Sub "${AWS::StackName}-allow-list"
      Domains:
        - "*.amazonaws.com"
        - "*.aws.amazon.com"
        - "*.awsapps.com"
        - "*.cloudfront.net"
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-allow-list"

  DnsFwDomainListAlertAll:
    Type: AWS::Route53Resolver::FirewallDomainList
    Properties:
      Name: !Sub "${AWS::StackName}-alert-all-list"
      Domains:
        - "*"
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-alert-all-list"

  DnsFwRuleGroup:
    Type: AWS::Route53Resolver::FirewallRuleGroup
    Properties:
      Name: !Sub "${AWS::StackName}-rule-group"
      FirewallRules:
        - FirewallDomainListId: !Ref DnsFwDomainListAllow
          Priority: 100
          Action: ALLOW
        - FirewallDomainListId: !Ref DnsFwDomainListAlertAll
          Priority: 200
          Action: ALERT
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-rule-group"

  DnsFwAssociation:
    Type: AWS::Route53Resolver::FirewallRuleGroupAssociation
    Properties:
      Name: !Sub "${AWS::StackName}-fw-assoc"
      FirewallRuleGroupId: !Ref DnsFwRuleGroup
      Priority: 101
      VpcId: !Ref PoCVPC
      MutationProtection: DISABLED
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-fw-assoc"

  # ============================================================
  # Route 53 Private Hosted Zone
  # ============================================================
  PoCPrivateHostedZone:
    Type: AWS::Route53::HostedZone
    Properties:
      Name: !Ref PrivateDomainName
      VPCs:
        - VPCId: !Ref PoCVPC
          VPCRegion: !Ref AWS::Region
      HostedZoneConfig:
        Comment: !Sub "Private Hosted Zone for ${AWS::StackName}"
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-hosted-zone"

  # Legacy record (kept) - points to legacy single Linux instance
  LinuxDnsRecord:
    Type: AWS::Route53::RecordSet
    Condition: BuildLinuxLegacy
    Properties:
      HostedZoneId: !Ref PoCPrivateHostedZone
      Name: !Sub "hub.${PrivateDomainName}."
      Type: A
      TTL: '300'
      ResourceRecords:
        - !GetAtt PoCInstance.PrivateIp

  # ASG record (new) - Alias to internal NLB (Linux Private ASG)
  LinuxDnsRecordAlias:
    Type: AWS::Route53::RecordSet
    Condition: CreateLinuxPrivateASG
    Properties:
      HostedZoneId: !Ref PoCPrivateHostedZone
      Name: !Sub "hub.${PrivateDomainName}."
      Type: A
      AliasTarget:
        DNSName: !GetAtt LinuxInternalNLB.DNSName
        HostedZoneId: !GetAtt LinuxInternalNLB.CanonicalHostedZoneID
        EvaluateTargetHealth: false

  # ============================================================
  # Internet Gateway
  # ============================================================
  PoCIGW:
    Type: AWS::EC2::InternetGateway
    Condition: IsInternetEnabled
    Properties:
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-igw"

  PoCIGWAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Condition: IsInternetEnabled
    Properties:
      VpcId: !Ref PoCVPC
      InternetGatewayId: !Ref PoCIGW

  # ============================================================
  # NAT Gateway
  # ============================================================
  NatEIP:
    Type: AWS::EC2::EIP
    Condition: IsInternetEnabled
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-nat-eip"

  NatGateway:
    Type: AWS::EC2::NatGateway
    Condition: IsInternetEnabled
    Properties:
      AllocationId: !GetAtt NatEIP.AllocationId
      SubnetId: !Ref PublicSubnet
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-nat-gw"

  # ============================================================
  # Route Tables
  # ============================================================
  # 1. Public Route Table (Goes to IGW)
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref PoCVPC
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-public-rt"

  PublicRoute:
    Type: AWS::EC2::Route
    Condition: IsInternetEnabled
    DependsOn: PoCIGWAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref PoCIGW

  PublicSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref PublicRouteTable

  # 2. Firewall Route Table (New: Goes to NAT Gateway)
  FirewallRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref PoCVPC
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-nfw-rt"

  FirewallRouteToNat:
    Type: AWS::EC2::Route
    Condition: IsInternetEnabled
    Properties:
      RouteTableId: !Ref FirewallRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway

  FirewallSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref FirewallSubnet
      RouteTableId: !Ref FirewallRouteTable

  # 3. Private Route Table (Goes to NAT GW initially)
  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref PoCVPC
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-private-rt"

  PrivateRouteToNat:
    Type: AWS::EC2::Route
    Condition: IsInternetEnabled
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway

  PrivateSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet
      RouteTableId: !Ref PrivateRouteTable

  # ============================================================
  # VPC Endpoints
  # ============================================================
  VpceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Condition: IsEndpointsEnabled
    Properties:
      GroupDescription: Allow HTTPS for VPC Endpoints
      VpcId: !Ref PoCVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 10.0.0.0/16

  SSMEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Condition: IsEndpointsEnabled
    Properties:
      VpcId: !Ref PoCVPC
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.ssm"
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds: [ !Ref PrivateSubnet ]
      SecurityGroupIds: [ !Ref VpceSecurityGroup ]

  EC2MessagesEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Condition: IsEndpointsEnabled
    Properties:
      VpcId: !Ref PoCVPC
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.ec2messages"
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds: [ !Ref PrivateSubnet ]
      SecurityGroupIds: [ !Ref VpceSecurityGroup ]

  SSMMessagesEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Condition: IsEndpointsEnabled
    Properties:
      VpcId: !Ref PoCVPC
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.ssmmessages"
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds: [ !Ref PrivateSubnet ]
      SecurityGroupIds: [ !Ref VpceSecurityGroup ]

  EC2ServiceEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Condition: IsEndpointsEnabled
    Properties:
      VpcId: !Ref PoCVPC
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.ec2"
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds: [ !Ref PrivateSubnet ]
      SecurityGroupIds: [ !Ref VpceSecurityGroup ]

  LogsEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Condition: IsEndpointsEnabled
    Properties:
      VpcId: !Ref PoCVPC
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.logs"
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds: [ !Ref PrivateSubnet ]
      SecurityGroupIds: [ !Ref VpceSecurityGroup ]

  S3Endpoint:
    Type: AWS::EC2::VPCEndpoint
    Condition: IsEndpointsEnabled
    Properties:
      VpcId: !Ref PoCVPC
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.s3"
      VpcEndpointType: Gateway
      RouteTableIds: [ !Ref PrivateRouteTable ]

  # ============================================================
  # Extra Resources (Logs & S3) - RESERVED
  # ============================================================
  ExtraLogGroup1:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "${AWS::StackName}-reserve-log-01"
      RetentionInDays: 7
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-reserve-log-01"

  ExtraLogGroup2:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "${AWS::StackName}-reserve-log-02"
      RetentionInDays: 7
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-reserve-log-02"

  ExtraLogGroup3:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "${AWS::StackName}-reserve-log-03"
      RetentionInDays: 7
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-reserve-log-03"

  ExtraS3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${AWS::StackName}-files-${AWS::AccountId}"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-files"

  # ============================================================
  # Security Groups
  # ============================================================
  PoCSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow SSH and App Ports
      VpcId: !Ref PoCVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref AllowedCidr
        - IpProtocol: tcp
          FromPort: 8000
          ToPort: 8003
          CidrIp: 10.0.0.0/16
        - IpProtocol: tcp
          FromPort: 8000
          ToPort: 8003
          CidrIp: !Ref AllowedCidr
        - IpProtocol: tcp
          FromPort: 8888
          ToPort: 8888
          CidrIp: 10.0.0.0/16
        - IpProtocol: tcp
          FromPort: 8888
          ToPort: 8888
          CidrIp: !Ref AllowedCidr

        # DNS
        - IpProtocol: udp
          FromPort: 53
          ToPort: 53
          CidrIp: 10.0.0.0/16
        - IpProtocol: tcp
          FromPort: 53
          ToPort: 53
          CidrIp: 10.0.0.0/16

        # Kerberos
        - IpProtocol: udp
          FromPort: 88
          ToPort: 88
          CidrIp: 10.0.0.0/16
        - IpProtocol: tcp
          FromPort: 88
          ToPort: 88
          CidrIp: 10.0.0.0/16

        # kpasswd (パスワード変更等)
        - IpProtocol: udp
          FromPort: 464
          ToPort: 464
          CidrIp: 10.0.0.0/16
        - IpProtocol: tcp
          FromPort: 464
          ToPort: 464
          CidrIp: 10.0.0.0/16

        # LDAP（ドメイン参加/照会）
        - IpProtocol: udp
          FromPort: 389
          ToPort: 389
          CidrIp: 10.0.0.0/16
        - IpProtocol: tcp
          FromPort: 389
          ToPort: 389
          CidrIp: 10.0.0.0/16

        # LDAPS（証明書/暗号化LDAP）
        - IpProtocol: tcp
          FromPort: 636
          ToPort: 636
          CidrIp: 10.0.0.0/16

        # SMB/CIFS（共有・一部のAD連携で使用）
        - IpProtocol: tcp
          FromPort: 445
          ToPort: 445
          CidrIp: 10.0.0.0/16

      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-sg"

  # ============================================================
  # IAM Role
  # ============================================================
  SSMRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy

  SSMInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref SSMRole

  # ============================================================
  # Compute (ASG/LT) - Linux
  # ============================================================
  LinuxPublicLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Condition: CreateLinuxPublicASG
    Properties:
      LaunchTemplateName: !Sub "${AWS::StackName}-lt-linux-public"
      LaunchTemplateData:
        ImageId: !If
          - IsAmazonLinux2
          - "{{resolve:ssm:/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2}}"
          - "{{resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64}}"
        InstanceType: !Ref InstanceType
        KeyName: !Ref PoCKeyPair
        IamInstanceProfile:
          Arn: !GetAtt SSMInstanceProfile.Arn
        BlockDeviceMappings:
          - DeviceName: /dev/xvda
            Ebs:
              VolumeSize: !Ref LinuxVolumeSize
              VolumeType: gp3
              DeleteOnTermination: true
        NetworkInterfaces:
          - DeviceIndex: 0
            AssociatePublicIpAddress: true
            Groups: [ !Ref PoCSecurityGroup ]
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash
            dnf update -y || yum update -y
            if command -v amazon-linux-extras &> /dev/null; then
              amazon-linux-extras install docker -y
            else
              dnf install -y docker
            fi
            systemctl start docker
            systemctl enable docker
            usermod -a -G docker root
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: !Sub "${AWS::StackName}-linux-public"
          - ResourceType: volume
            Tags:
              - Key: Name
                Value: !Sub "${AWS::StackName}-linux-public-vol"

  LinuxPrivateLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Condition: CreateLinuxPrivateASG
    Properties:
      LaunchTemplateName: !Sub "${AWS::StackName}-lt-linux-private"
      LaunchTemplateData:
        ImageId: !If
          - IsAmazonLinux2
          - "{{resolve:ssm:/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2}}"
          - "{{resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64}}"
        InstanceType: !Ref InstanceType
        KeyName: !Ref PoCKeyPair
        IamInstanceProfile:
          Arn: !GetAtt SSMInstanceProfile.Arn
        BlockDeviceMappings:
          - DeviceName: /dev/xvda
            Ebs:
              VolumeSize: !Ref LinuxVolumeSize
              VolumeType: gp3
              DeleteOnTermination: true
        NetworkInterfaces:
          - DeviceIndex: 0
            AssociatePublicIpAddress: false
            Groups: [ !Ref PoCSecurityGroup ]
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash
            dnf update -y || yum update -y
            if command -v amazon-linux-extras &> /dev/null; then
              amazon-linux-extras install docker -y
            else
              dnf install -y docker
            fi
            systemctl start docker
            systemctl enable docker
            usermod -a -G docker root
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: !Sub "${AWS::StackName}-linux-private"
          - ResourceType: volume
            Tags:
              - Key: Name
                Value: !Sub "${AWS::StackName}-linux-private-vol"

  LinuxPublicASG:
    Type: AWS::AutoScaling::AutoScalingGroup
    Condition: CreateLinuxPublicASG
    Properties:
      VPCZoneIdentifier: [ !Ref PublicSubnet ]
      MinSize: "0"
      MaxSize: !Ref LinuxPublicCount
      DesiredCapacity: !Ref LinuxPublicCount
      LaunchTemplate:
        LaunchTemplateId: !Ref LinuxPublicLaunchTemplate
        Version: !GetAtt LinuxPublicLaunchTemplate.LatestVersionNumber
      HealthCheckType: EC2
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-linux-public"
          PropagateAtLaunch: true

  # Internal NLB for hub.<domain> (Linux Private ASG)
  LinuxInternalNLB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Condition: CreateLinuxPrivateASG
    Properties:
      Name: !Sub "${AWS::StackName}-hub-nlb"
      Type: network
      Scheme: internal
      Subnets: [ !Ref PrivateSubnet ]
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-hub-nlb"

  LinuxNlbTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Condition: CreateLinuxPrivateASG
    Properties:
      Name: !Sub "${AWS::StackName}-hub-tg"
      VpcId: !Ref PoCVPC
      Port: 8888
      Protocol: TCP
      TargetType: instance
      HealthCheckProtocol: TCP

  LinuxNlbListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Condition: CreateLinuxPrivateASG
    Properties:
      LoadBalancerArn: !Ref LinuxInternalNLB
      Port: 8888
      Protocol: TCP
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref LinuxNlbTargetGroup

  LinuxPrivateASG:
    Type: AWS::AutoScaling::AutoScalingGroup
    Condition: CreateLinuxPrivateASG
    Properties:
      VPCZoneIdentifier: [ !Ref PrivateSubnet ]
      MinSize: "0"
      MaxSize: !Ref LinuxPrivateCount
      DesiredCapacity: !Ref LinuxPrivateCount
      LaunchTemplate:
        LaunchTemplateId: !Ref LinuxPrivateLaunchTemplate
        Version: !GetAtt LinuxPrivateLaunchTemplate.LatestVersionNumber
      TargetGroupARNs:
        - !Ref LinuxNlbTargetGroup
      HealthCheckType: EC2
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-linux-private"
          PropagateAtLaunch: true

  # ============================================================
  # Compute (ASG/LT) - Windows
  # ============================================================
  WindowsPublicLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Condition: CreateWindowsPublicASG
    Properties:
      LaunchTemplateName: !Sub "${AWS::StackName}-lt-windows-public"
      LaunchTemplateData:
        ImageId: !Sub "{{resolve:ssm:/aws/service/ami-windows-latest/Windows_Server-${WindowsServerVersion}-English-Full-Base}}"
        InstanceType: !Ref WindowsInstanceType
        KeyName: !Ref PoCKeyPair
        IamInstanceProfile:
          Arn: !GetAtt SSMInstanceProfile.Arn
        BlockDeviceMappings:
          - DeviceName: /dev/sda1
            Ebs:
              VolumeSize: !Ref WindowsVolumeSize
              VolumeType: gp3
              DeleteOnTermination: true
        NetworkInterfaces:
          - DeviceIndex: 0
            AssociatePublicIpAddress: true
            Groups: [ !Ref PoCSecurityGroup ]
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: !Sub "${AWS::StackName}-windows-${WindowsServerVersion}-public"
          - ResourceType: volume
            Tags:
              - Key: Name
                Value: !Sub "${AWS::StackName}-windows-${WindowsServerVersion}-public-vol"

  WindowsPrivateLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Condition: CreateWindowsPrivateASG
    Properties:
      LaunchTemplateName: !Sub "${AWS::StackName}-lt-windows-private"
      LaunchTemplateData:
        ImageId: !Sub "{{resolve:ssm:/aws/service/ami-windows-latest/Windows_Server-${WindowsServerVersion}-English-Full-Base}}"
        InstanceType: !Ref WindowsInstanceType
        KeyName: !Ref PoCKeyPair
        IamInstanceProfile:
          Arn: !GetAtt SSMInstanceProfile.Arn
        BlockDeviceMappings:
          - DeviceName: /dev/sda1
            Ebs:
              VolumeSize: !Ref WindowsVolumeSize
              VolumeType: gp3
              DeleteOnTermination: true
        NetworkInterfaces:
          - DeviceIndex: 0
            AssociatePublicIpAddress: false
            Groups: [ !Ref PoCSecurityGroup ]
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: !Sub "${AWS::StackName}-windows-${WindowsServerVersion}-private"
          - ResourceType: volume
            Tags:
              - Key: Name
                Value: !Sub "${AWS::StackName}-windows-${WindowsServerVersion}-private-vol"

  WindowsPublicASG:
    Type: AWS::AutoScaling::AutoScalingGroup
    Condition: CreateWindowsPublicASG
    Properties:
      VPCZoneIdentifier: [ !Ref PublicSubnet ]
      MinSize: "0"
      MaxSize: !Ref WindowsPublicCount
      DesiredCapacity: !Ref WindowsPublicCount
      LaunchTemplate:
        LaunchTemplateId: !Ref WindowsPublicLaunchTemplate
        Version: !GetAtt WindowsPublicLaunchTemplate.LatestVersionNumber
      HealthCheckType: EC2
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-windows-${WindowsServerVersion}-public"
          PropagateAtLaunch: true

  WindowsPrivateASG:
    Type: AWS::AutoScaling::AutoScalingGroup
    Condition: CreateWindowsPrivateASG
    Properties:
      VPCZoneIdentifier: [ !Ref PrivateSubnet ]
      MinSize: "0"
      MaxSize: !Ref WindowsPrivateCount
      DesiredCapacity: !Ref WindowsPrivateCount
      LaunchTemplate:
        LaunchTemplateId: !Ref WindowsPrivateLaunchTemplate
        Version: !GetAtt WindowsPrivateLaunchTemplate.LatestVersionNumber
      HealthCheckType: EC2
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-windows-${WindowsServerVersion}-private"
          PropagateAtLaunch: true

  # ============================================================
  # Compute (Legacy Single EC2) - Kept but Disabled by default
  # ============================================================
  PoCInstance:
    Type: AWS::EC2::Instance
    Condition: BuildLinuxLegacy
    Properties:
      ImageId: !If
        - IsAmazonLinux2
        - "{{resolve:ssm:/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2}}"
        - "{{resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64}}"
      InstanceType: !Ref InstanceType
      KeyName: !Ref PoCKeyPair
      IamInstanceProfile: !Ref SSMInstanceProfile
      AvailabilityZone: !Ref TargetAZ
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: !Ref LinuxVolumeSize
            VolumeType: gp3
            DeleteOnTermination: true
      NetworkInterfaces:
        - AssociatePublicIpAddress: false
          DeviceIndex: 0
          GroupSet: [ !Ref PoCSecurityGroup ]
          SubnetId: !Ref PrivateSubnet
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          dnf update -y || yum update -y
          if command -v amazon-linux-extras &> /dev/null; then
            amazon-linux-extras install docker -y
          else
            dnf install -y docker
          fi
          systemctl start docker
          systemctl enable docker
          usermod -a -G docker root
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-linux-legacy"

  PoCWindowsInstance:
    Type: AWS::EC2::Instance
    Condition: BuildWindowsLegacy
    Properties:
      ImageId: !Sub "{{resolve:ssm:/aws/service/ami-windows-latest/Windows_Server-${WindowsServerVersion}-English-Full-Base}}"
      InstanceType: !Ref WindowsInstanceType
      KeyName: !Ref PoCKeyPair
      IamInstanceProfile: !Ref SSMInstanceProfile
      AvailabilityZone: !Ref TargetAZ
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: !Ref WindowsVolumeSize
            VolumeType: gp3
            DeleteOnTermination: true
      NetworkInterfaces:
        - AssociatePublicIpAddress: false
          DeviceIndex: 0
          GroupSet: [ !Ref PoCSecurityGroup ]
          SubnetId: !Ref PrivateSubnet
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-windows-${WindowsServerVersion}-legacy"

Outputs:
  # --- ASG outputs (new) ---
  LinuxPublicASGName:
    Condition: CreateLinuxPublicASG
    Value: !Ref LinuxPublicASG
    Description: Linux Public ASG name

  LinuxPrivateASGName:
    Condition: CreateLinuxPrivateASG
    Value: !Ref LinuxPrivateASG
    Description: Linux Private ASG name

  LinuxHubDnsName:
    Condition: CreateLinuxPrivateASG
    Value: !Sub "hub.${PrivateDomainName}"
    Description: Private DNS (Alias -> Internal NLB -> Linux Private ASG)

  WindowsPublicASGName:
    Condition: CreateWindowsPublicASG
    Value: !Ref WindowsPublicASG
    Description: Windows Public ASG name

  WindowsPrivateASGName:
    Condition: CreateWindowsPrivateASG
    Value: !Ref WindowsPrivateASG
    Description: Windows Private ASG name

  # --- Legacy outputs (kept) ---
  LinuxInstanceId:
    Condition: BuildLinuxLegacy
    Value: !Ref PoCInstance
    Description: Linux Server ID (Legacy / Private)

  LinuxPrivateIP:
    Condition: BuildLinuxLegacy
    Value: !GetAtt PoCInstance.PrivateIp
    Description: Private IP Address (Legacy)

  LinuxDnsName:
    Condition: BuildLinuxLegacy
    Value: !Sub "hub.${PrivateDomainName}"
    Description: Private DNS Record for Linux (Legacy - A record to private IP)

  WindowsInstanceId:
    Condition: BuildWindowsLegacy
    Value: !Ref PoCWindowsInstance
    Description: Windows Server ID (Legacy / Private)

  ConnectToWindows:
    Condition: BuildWindowsLegacy
    Description: Fleet Manager RDP Link (Legacy)
    Value: !Sub "https://${AWS::Region}.console.aws.amazon.com/systems-manager/fleet-manager/rdp?instanceId=${PoCWindowsInstance}"

  PrivateKeyLocation:
    Description: Retrieve Private Key content from here to decrypt Windows password
    Value: !Sub "/ec2/keypair/${PoCKeyPair}"

  NetworkType:
    Value: !If [ IsInternetEnabled, "Internet Enabled (NAT GW + IGW)", "Closed Network (No Internet)" ]
    Description: Current Network Configuration

  ReservedS3Bucket:
    Value: !Ref ExtraS3Bucket
    Description: Name of the reserved S3 Bucket

  ReservedLogGroups:
    Value: !Sub "${ExtraLogGroup1}, ${ExtraLogGroup2}, ${ExtraLogGroup3}"
    Description: Names of the 3 reserved CloudWatch Log Groups
