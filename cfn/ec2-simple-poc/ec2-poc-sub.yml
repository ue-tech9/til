AWSTemplateFormatVersion: '2010-09-09'
Description: Full Stack EC2 PoC with Network Firewall (Public/Private/NFW Subnets + R53 Private DNS + VPC Endpoints + NFW)

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label: 
          default: "① Linux Configuration"
        Parameters:
          - CreateLinuxInstance
          - OsVersion
          - InstanceType
          - LinuxVolumeSize
      - Label: 
          default: "② Windows Configuration"
        Parameters:
          - CreateWindowsInstance
          - WindowsServerVersion
          - WindowsInstanceType
          - WindowsVolumeSize
      - Label: 
          default: "③ Network & Access"
        Parameters:
          - TargetAZ       
          - EnableInternetAccess
          - EnableVPCEndpoints
          - AllowedCidr
      - Label:
          default: "④ Private DNS (Route53)"
        Parameters:
          - PrivateDomainName
    ParameterLabels:
      CreateLinuxInstance:
        default: "Create Linux Instance?"
      CreateWindowsInstance:
        default: "Create Windows Instance?"
      EnableInternetAccess:
        default: "Create IGW & NAT Gateway?"
      EnableVPCEndpoints:
        default: "Create VPC Endpoints?"
      PrivateDomainName:
        default: "Private Hosted Zone Name"

Parameters:
  TargetAZ:
    Description: Select the Availability Zone.
    Type: AWS::EC2::AvailabilityZone::Name
  
  CreateLinuxInstance:
    Type: String
    Default: "true"
    AllowedValues: ["true", "false"]
    Description: Select "true" to deploy Linux Server.

  OsVersion:
    Type: String
    Default: AmazonLinux2
    AllowedValues:
      - AmazonLinux2023
      - AmazonLinux2
    Description: Select the OS version for Linux Server.

  InstanceType:
    Type: String
    Default: t3.medium
    AllowedValues:
      - t3.micro
      - t3.small
      - t3.medium
    Description: Select Linux instance type.

  LinuxVolumeSize:
    Type: Number
    Default: 50
    MinValue: 8
    MaxValue: 16000
    Description: Size of the root volume for Linux (GB).

  CreateWindowsInstance:
    Type: String
    Default: "true"
    AllowedValues: ["true", "false"]
    Description: Select "true" to deploy Windows Server.

  WindowsServerVersion:
    Type: String
    Default: "2022"
    AllowedValues:
      - "2022"
      - "2019"
      - "2016"
    Description: Select Windows Server OS version.

  WindowsInstanceType:
    Type: String
    Default: t3.large
    AllowedValues:
      - t3.medium
      - t3.large
      - m5.large
    Description: Select Windows instance type.

  WindowsVolumeSize:
    Type: Number
    Default: 50
    MinValue: 30
    MaxValue: 16000
    Description: Size of the root volume for Windows (GB).
  
  EnableInternetAccess:
    Type: String
    Default: "true"
    AllowedValues: ["true", "false"]
    Description: If true, IGW and NAT Gateway are created. If false, Closed Network.

  EnableVPCEndpoints:
    Type: String
    Default: "true"
    AllowedValues: ["true", "false"]
    Description: Required for SSM/Yum/Logs if Internet Access is false.

  AllowedCidr:
    Type: String
    Default: 10.0.0.0/16
    Description: IP range allowed for SSH (22) and App Ports within SG.

  PrivateDomainName:
    Type: String
    Default: "corp.internal"
    Description: The domain name for the Private Hosted Zone (e.g. corp.internal).

Conditions:
  BuildLinux: !Equals [ !Ref CreateLinuxInstance, "true" ]
  BuildWindows: !Equals [ !Ref CreateWindowsInstance, "true" ]
  IsAmazonLinux2: !Equals [ !Ref OsVersion, "AmazonLinux2" ]
  IsInternetEnabled: !Equals [ !Ref EnableInternetAccess, "true" ]
  IsEndpointsEnabled: !Equals [ !Ref EnableVPCEndpoints, "true" ]

Resources:
  # ============================================================
  # Key Pair (Common)
  # ============================================================
  PoCKeyPair:
    Type: AWS::EC2::KeyPair
    Properties:
      KeyName: !Sub "${AWS::StackName}-key"
      KeyType: rsa
      KeyFormat: pem

  # ============================================================
  # Base Network (VPC & Subnets)
  # ============================================================
  PoCVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-vpc"

  # Public Subnet (For NAT GW / IGW)
  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref PoCVPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Ref TargetAZ 
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-public-subnet"

  # Private Subnet (For Instances & Endpoints)
  PrivateSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref PoCVPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Ref TargetAZ 
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-private-subnet"

  # Network Firewall Subnet
  FirewallSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref PoCVPC
      CidrBlock: 10.0.3.0/24
      AvailabilityZone: !Ref TargetAZ
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-nfw-subnet"

  # ============================================================
  # Network Firewall Resources
  # ============================================================
  
  # 1. Stateless Rule Group (Pass All)
  NFWRuleGroup:
    Type: AWS::NetworkFirewall::RuleGroup
    Properties:
      RuleGroupName: !Sub "${AWS::StackName}-allow-all-rg"
      Type: STATELESS
      Capacity: 100
      RuleGroup:
        RulesSource:
          StatelessRulesAndCustomActions:
            StatelessRules:
              - Priority: 1
                RuleDefinition:
                  Actions: ["aws:pass"]
                  MatchAttributes:
                    Sources: [ { AddressDefinition: "0.0.0.0/0" } ]
                    Destinations: [ { AddressDefinition: "0.0.0.0/0" } ]
                    Protocols: [] # All protocols
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-allow-all-rg"

  # 2. Firewall Policy
  NFWPolicy:
    Type: AWS::NetworkFirewall::FirewallPolicy
    Properties:
      FirewallPolicyName: !Sub "${AWS::StackName}-policy"
      FirewallPolicy:
        StatelessDefaultActions: ["aws:forward_to_sfe"]
        StatelessFragmentDefaultActions: ["aws:forward_to_sfe"]
        StatelessRuleGroupReferences:
          - ResourceArn: !Ref NFWRuleGroup
            Priority: 10
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-policy"

  # 3. Network Firewall Instance
  NetworkFirewall:
    Type: AWS::NetworkFirewall::Firewall
    Properties:
      FirewallName: !Sub "${AWS::StackName}-nfw"
      FirewallPolicyArn: !Ref NFWPolicy
      VpcId: !Ref PoCVPC
      SubnetMappings:
        - SubnetId: !Ref FirewallSubnet
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-nfw"

  # ============================================================
  # Route 53 Resolver DNS Firewall
  # ============================================================
  DnsFwDomainListAllow:
    Type: AWS::Route53Resolver::FirewallDomainList
    Properties:
      Name: !Sub "${AWS::StackName}-allow-list"
      Domains:
        - "*.amazonaws.com"
        - "*.aws.amazon.com"
        - "*.awsapps.com"
        - "*.okta.com"
        - "*.oktacdn.com"
        - "*.cloudfront.net"
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-allow-list"

  DnsFwDomainListAlertAll:
    Type: AWS::Route53Resolver::FirewallDomainList
    Properties:
      Name: !Sub "${AWS::StackName}-alert-all-list"
      Domains:
        - "*"
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-alert-all-list"

  DnsFwRuleGroup:
    Type: AWS::Route53Resolver::FirewallRuleGroup
    Properties:
      Name: !Sub "${AWS::StackName}-rule-group"
      FirewallRules:
        - FirewallDomainListId: !Ref DnsFwDomainListAllow
          Priority: 100
          Action: ALLOW
        - FirewallDomainListId: !Ref DnsFwDomainListAlertAll
          Priority: 200
          Action: ALERT
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-rule-group"

  DnsFwAssociation:
    Type: AWS::Route53Resolver::FirewallRuleGroupAssociation
    Properties:
      Name: !Sub "${AWS::StackName}-fw-assoc"
      FirewallRuleGroupId: !Ref DnsFwRuleGroup
      Priority: 101
      VpcId: !Ref PoCVPC
      MutationProtection: DISABLED
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-fw-assoc"

  # ============================================================
  # Route 53 Private Hosted Zone
  # ============================================================
  PoCPrivateHostedZone:
    Type: AWS::Route53::HostedZone
    Properties:
      Name: !Ref PrivateDomainName
      VPCs:
        - VPCId: !Ref PoCVPC
          VPCRegion: !Ref AWS::Region
      HostedZoneConfig:
        Comment: !Sub "Private Hosted Zone for ${AWS::StackName}"
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-hosted-zone"

  LinuxDnsRecord:
    Type: AWS::Route53::RecordSet
    Condition: BuildLinux
    Properties:
      HostedZoneId: !Ref PoCPrivateHostedZone
      Name: !Sub "hub.${PrivateDomainName}."
      Type: A
      TTL: '300'
      ResourceRecords:
        - !GetAtt PoCInstance.PrivateIp

  # ============================================================
  # Internet Gateway
  # ============================================================
  PoCIGW:
    Type: AWS::EC2::InternetGateway
    Condition: IsInternetEnabled
    Properties:
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-igw"

  PoCIGWAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Condition: IsInternetEnabled
    Properties:
      VpcId: !Ref PoCVPC
      InternetGatewayId: !Ref PoCIGW

  # ============================================================
  # NAT Gateway
  # ============================================================
  NatEIP:
    Type: AWS::EC2::EIP
    Condition: IsInternetEnabled
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-nat-eip"

  NatGateway:
    Type: AWS::EC2::NatGateway
    Condition: IsInternetEnabled
    Properties:
      AllocationId: !GetAtt NatEIP.AllocationId
      SubnetId: !Ref PublicSubnet
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-nat-gw"

  # ============================================================
  # Route Tables
  # ============================================================
  # 1. Public Route Table (Goes to IGW)
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref PoCVPC
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-public-rt"

  PublicRoute:
    Type: AWS::EC2::Route
    Condition: IsInternetEnabled
    DependsOn: PoCIGWAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref PoCIGW

  PublicSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref PublicRouteTable

  # 2. Firewall Route Table (New: Goes to NAT Gateway)
  # ------------------------------------------------------------
  FirewallRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref PoCVPC
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-nfw-rt"

  FirewallRouteToNat:
    Type: AWS::EC2::Route
    Condition: IsInternetEnabled
    Properties:
      RouteTableId: !Ref FirewallRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway

  FirewallSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref FirewallSubnet
      RouteTableId: !Ref FirewallRouteTable

  # 3. Private Route Table (Goes to NAT GW initially)
  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref PoCVPC
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-private-rt"

  # Note: 
  # To enable Firewall inspection, you will manually update this Route
  # to point to the "Gateway Load Balancer Endpoint" (NFW) instead of NatGateway.
  PrivateRouteToNat:
    Type: AWS::EC2::Route
    Condition: IsInternetEnabled
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway

  PrivateSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet
      RouteTableId: !Ref PrivateRouteTable

  # ============================================================
  # VPC Endpoints
  # ============================================================
  VpceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Condition: IsEndpointsEnabled
    Properties:
      GroupDescription: Allow HTTPS for VPC Endpoints
      VpcId: !Ref PoCVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 10.0.0.0/16

  SSMEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Condition: IsEndpointsEnabled
    Properties:
      VpcId: !Ref PoCVPC
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.ssm"
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds: [ !Ref PrivateSubnet ]
      SecurityGroupIds: [ !Ref VpceSecurityGroup ]

  EC2MessagesEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Condition: IsEndpointsEnabled
    Properties:
      VpcId: !Ref PoCVPC
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.ec2messages"
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds: [ !Ref PrivateSubnet ]
      SecurityGroupIds: [ !Ref VpceSecurityGroup ]

  SSMMessagesEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Condition: IsEndpointsEnabled
    Properties:
      VpcId: !Ref PoCVPC
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.ssmmessages"
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds: [ !Ref PrivateSubnet ]
      SecurityGroupIds: [ !Ref VpceSecurityGroup ]

  EC2ServiceEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Condition: IsEndpointsEnabled
    Properties:
      VpcId: !Ref PoCVPC
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.ec2"
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds: [ !Ref PrivateSubnet ]
      SecurityGroupIds: [ !Ref VpceSecurityGroup ]

  LogsEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Condition: IsEndpointsEnabled
    Properties:
      VpcId: !Ref PoCVPC
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.logs"
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds: [ !Ref PrivateSubnet ]
      SecurityGroupIds: [ !Ref VpceSecurityGroup ]

  S3Endpoint:
    Type: AWS::EC2::VPCEndpoint
    Condition: IsEndpointsEnabled
    Properties:
      VpcId: !Ref PoCVPC
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.s3"
      VpcEndpointType: Gateway
      RouteTableIds: [ !Ref PrivateRouteTable ]

  # ============================================================
  # Security Groups
  # ============================================================
  PoCSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow SSH and App Ports
      VpcId: !Ref PoCVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref AllowedCidr
        - IpProtocol: tcp
          FromPort: 8000
          ToPort: 8003
          CidrIp: 10.0.0.0/16
        - IpProtocol: tcp
          FromPort: 8000
          ToPort: 8003
          CidrIp: !Ref AllowedCidr
        - IpProtocol: tcp
          FromPort: 8888
          ToPort: 8888
          CidrIp: 10.0.0.0/16
        - IpProtocol: tcp
          FromPort: 8888
          ToPort: 8888
          CidrIp: !Ref AllowedCidr
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-sg"

  # ============================================================
  # IAM Role
  # ============================================================
  SSMRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy

  SSMInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref SSMRole

  # ============================================================
  # Compute (Linux)
  # ============================================================
  PoCInstance:
    Type: AWS::EC2::Instance
    Condition: BuildLinux
    Properties:
      ImageId: !If 
        - IsAmazonLinux2
        - '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2}}'
        - '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64}}'
      InstanceType: !Ref InstanceType
      KeyName: !Ref PoCKeyPair
      IamInstanceProfile: !Ref SSMInstanceProfile
      AvailabilityZone: !Ref TargetAZ
      BlockDeviceMappings: 
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: !Ref LinuxVolumeSize
            VolumeType: gp3
            DeleteOnTermination: true
      NetworkInterfaces: 
        - AssociatePublicIpAddress: false
          DeviceIndex: 0
          GroupSet: [ !Ref PoCSecurityGroup ]
          SubnetId: !Ref PrivateSubnet
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          dnf update -y || yum update -y
          if command -v amazon-linux-extras &> /dev/null; then
            amazon-linux-extras install docker -y
          else
            dnf install -y docker
          fi
          systemctl start docker
          systemctl enable docker
          usermod -a -G docker root
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-linux"

  # ============================================================
  # Compute (Windows Server)
  # ============================================================
  PoCWindowsInstance:
    Type: AWS::EC2::Instance
    Condition: BuildWindows
    Properties:
      ImageId: !Sub '{{resolve:ssm:/aws/service/ami-windows-latest/Windows_Server-${WindowsServerVersion}-English-Full-Base}}'
      InstanceType: !Ref WindowsInstanceType
      KeyName: !Ref PoCKeyPair
      IamInstanceProfile: !Ref SSMInstanceProfile
      AvailabilityZone: !Ref TargetAZ
      BlockDeviceMappings: 
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: !Ref WindowsVolumeSize
            VolumeType: gp3
            DeleteOnTermination: true
      NetworkInterfaces: 
        - AssociatePublicIpAddress: false
          DeviceIndex: 0
          GroupSet: [ !Ref PoCSecurityGroup ]
          SubnetId: !Ref PrivateSubnet
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-windows-${WindowsServerVersion}"

Outputs:
  LinuxInstanceId:
    Condition: BuildLinux
    Value: !Ref PoCInstance
    Description: Linux Server ID (Private)
  LinuxPrivateIP:
    Condition: BuildLinux
    Value: !GetAtt PoCInstance.PrivateIp
    Description: Private IP Address
  LinuxDnsName:
    Condition: BuildLinux
    Value: !Sub "hub.${PrivateDomainName}"
    Description: Private DNS Record for Linux
  WindowsInstanceId:
    Condition: BuildWindows
    Value: !Ref PoCWindowsInstance
    Description: Windows Server ID (Private)
  ConnectToWindows:
    Condition: BuildWindows
    Description: Fleet Manager RDP Link
    Value: !Sub "https://${AWS::Region}.console.aws.amazon.com/systems-manager/fleet-manager/rdp?instanceId=${PoCWindowsInstance}"
  PrivateKeyLocation:
    Description: Retrieve Private Key content from here to decrypt Windows password
    Value: !Sub "/ec2/keypair/${PoCKeyPair}"
  NetworkType:
    Value: !If [ IsInternetEnabled, "Internet Enabled (NAT GW + IGW)", "Closed Network (No Internet)" ]
    Description: Current Network Configuration
  DnsFirewallRuleGroup:
    Value: !Ref DnsFwRuleGroup
    Description: Route 53 Resolver DNS Firewall Rule Group ID
  NetworkFirewallArn:
    Value: !Ref NetworkFirewall
    Description: Network Firewall ARN
  NetworkFirewallEndpointIds:
    Value: !Join [",", !GetAtt NetworkFirewall.EndpointIds]
    Description: "List of VPCE IDs created by Network Firewall. Use these for Route Table targeting later."